---
  - name: Add users
    hosts: local
    connection: local
    gather_facts: False
    
    # Create MFA policy
    tasks:
    - name: Execute the command in remote shell; Create Policies 
      script: ./aws-cria-policy.sh forceMFA force_mfapolicy.txt
      register: out

    - debug: var=out.stdout_lines

    # Create Groups
    - name: Execute the command in remote shell; Create Groups 
      script: ./aws-cria-grupo.sh usuarios2.csv
      register: out

    - debug: var=out.stdout_lines

    # Attach policies to groups
    - name: Execute the command in remote shell; Attach Policies to Groups 
      script: ./aws-attach-policy.sh usuarios2.csv
      register: out

    - debug: var=out.stdout_lines

    # Create Users, Pass and Add users to Groups
    - read_csv:
        path: usuarios2.csv
        key: usuarios
      register: users

    - name: Create IAM Users and Password
      community.aws.iam:
        iam_type: user
        name: "{{ item.value.usuarios }}"
        state: present
        password: "{{ item.value.senha }}"
        groups: "{{ item.value.grupo }}"
        access_key_state: create
      loop: "{{ users.dict|dict2items }}"



